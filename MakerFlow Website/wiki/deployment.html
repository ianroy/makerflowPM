<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Wiki | Deployment</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=Source+Sans+3:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/website/assets/site.css" />
  </head>
  <body class="site-root">
    <header class="site-header">
      <a class="brand-mark" href="/website/">
        <img src="/website/assets/logo.svg" alt="MakerFlow PM logo" />
        <span><strong>MakerFlow PM</strong><em>Deployment</em></span>
      </a>
      <nav class="site-nav"><a href="/website/wiki/">Wiki Home</a><a href="/login">App Login</a></nav>
      <div class="site-actions"><a class="btn" href="/login">Launch App</a></div>
    </header>
    <main class="wiki-layout">
      <aside class="wiki-nav">
        <h2>Wiki Pages</h2>
        <a href="/website/wiki/">Overview</a>
        <a href="/website/wiki/getting-started.html">Getting Started</a>
        <a href="/website/wiki/deployment.html" aria-current="page">Deployment</a>
        <a href="/website/wiki/architecture.html">Architecture</a>
        <a href="/website/wiki/data-model.html">Data Model</a>
        <a href="/website/wiki/api-routes.html">API and Routes</a>
        <a href="/website/wiki/operations.html">Operations</a>
        <a href="/website/wiki/file-map.html">Full File Map</a>
        <a href="/website/wiki/release-notes.html">Release Notes</a>
      </aside>
      <article class="wiki-content">
        <h1>Production Deployment</h1>
        <p><strong>Repository:</strong> <a href="https://github.com/ianroy/makerflowPM" target="_blank" rel="noreferrer">github.com/ianroy/makerflowPM</a></p>
        <p>Use the deployment script for a low-cost VM setup with <code>systemd + nginx + TLS</code>.</p>
        <pre><code>./scripts/deploy_production.sh \
  --ssh ubuntu@YOUR_SERVER_IP \
  --domain makerflow.org \
  --admin-email admin@yourdomain.edu \
  --admin-password 'REPLACE_WITH_STRONG_PASSWORD'</code></pre>

        <h2>What the Script Configures</h2>
        <ul>
          <li>Uploads source code to <code>/opt/makerflow-pm</code>.</li>
          <li>Creates/updates <code>makerflow.service</code>.</li>
          <li>Creates nginx site and reverse proxy.</li>
          <li>Optionally issues cert via certbot.</li>
          <li>Installs daily backup cron for DB snapshots.</li>
        </ul>

        <h2>Validation Commands</h2>
        <pre><code>sudo systemctl status makerflow
sudo nginx -t
curl -i http://127.0.0.1:8080/healthz</code></pre>

        <h2>DigitalOcean App Platform</h2>
        <p>Use the included App Platform spec for container-style deploys:</p>
        <pre><code>doctl apps create --spec .do/app.yaml
doctl apps update &lt;APP_ID&gt; --spec .do/app.yaml</code></pre>
        <p>Use these service commands in the App Platform UI/spec:</p>
        <pre><code>Build command: pip install -r requirements.txt
Run command: gunicorn wsgi:application --bind 0.0.0.0:$PORT --workers 2 --threads 2 --timeout 120</code></pre>
        <p>The spec is configured for App Platform health checks:</p>
        <ul>
          <li>Run command binds to <code>0.0.0.0:$PORT</code>.</li>
          <li>Build command installs runtime dependencies from <code>requirements.txt</code>.</li>
          <li>Service HTTP port is <code>8080</code>.</li>
          <li>Health check path is <code>/healthz</code>.</li>
          <li>Initial delay is set to <code>30s</code>.</li>
        </ul>

        <h2>Health Check Troubleshooting</h2>
        <ul>
          <li>Verify App Platform uses the spec from <code>.do/app.yaml</code>.</li>
          <li>Confirm <code>/healthz</code> returns <code>200 OK</code> without login.</li>
          <li>Confirm no custom startup command overrides the bind address.</li>
          <li>If deploys still fail, increase initial delay to <code>45-60s</code>.</li>
        </ul>

        <h2>Security Requirements</h2>
        <ul>
          <li>Set <code>MAKERSPACE_COOKIE_SECURE=1</code>.</li>
          <li>Use a 64+ character <code>MAKERSPACE_SECRET_KEY</code>.</li>
          <li>Rotate bootstrap passwords immediately after first login.</li>
          <li>Restrict SSH to key-based auth.</li>
        </ul>
      </article>
    </main>
  </body>
</html>
