<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Wiki | Deployment</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=Source+Sans+3:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/website/assets/site.css" />
  </head>
  <body class="site-root">
    <header class="site-header">
      <a class="brand-mark" href="/website/">
        <img src="/website/assets/logo.svg" alt="MakerFlow PM logo" />
        <span><strong>MakerFlow PM</strong><em>Deployment</em></span>
      </a>
      <nav class="site-nav"><a href="/website/wiki/">Wiki Home</a><a href="/login">App Login</a></nav>
      <div class="site-actions"><a class="btn" href="/login">Launch App</a></div>
    </header>
    <main class="wiki-layout">
      <aside class="wiki-nav">
        <h2>Wiki Pages</h2>
        <a href="/website/wiki/">Overview</a>
        <a href="/website/wiki/getting-started.html">Getting Started</a>
        <a href="/website/wiki/deployment.html" aria-current="page">Deployment</a>
        <a href="/website/wiki/architecture.html">Architecture</a>
        <a href="/website/wiki/data-model.html">Data Model</a>
        <a href="/website/wiki/api-routes.html">API and Routes</a>
        <a href="/website/wiki/operations.html">Operations</a>
        <a href="/website/wiki/file-map.html">Full File Map</a>
        <a href="/website/wiki/release-notes.html">Release Notes</a>
      </aside>
      <article class="wiki-content">
        <h1>Deployment Guide (DigitalOcean + Local)</h1>
        <p><strong>Repository:</strong> <a href="https://github.com/ianroy/makerflowPM" target="_blank" rel="noreferrer">github.com/ianroy/makerflowPM</a></p>

        <h2>Local Test Environment</h2>
        <pre><code>git clone https://github.com/ianroy/makerflowPM.git
cd makerflowPM
cp .env.example .env
pip install -r requirements.txt
python3 app/server.py</code></pre>
        <p>Open <code>http://127.0.0.1:8080/login</code>.</p>

        <h2>DigitalOcean Droplet (Recommended)</h2>
        <pre><code>./scripts/deploy_production.sh \
  --ssh ubuntu@YOUR_DROPLET_IP \
  --domain makerflow.org \
  --admin-email admin@yourdomain.edu \
  --admin-password 'REPLACE_WITH_STRONG_PASSWORD'</code></pre>

        <h2>DigitalOcean App Platform</h2>
        <p>Use the included spec: <code>.do/app.yaml</code>.</p>
        <pre><code>doctl apps create --spec .do/app.yaml
doctl apps update &lt;APP_ID&gt; --spec .do/app.yaml</code></pre>

        <p>If configuring manually, use:</p>
        <pre><code>Build command: pip install -r requirements.txt
Run command: bash -lc "python3 scripts/bootstrap_db.py && gunicorn wsgi:application --bind 0.0.0.0:$PORT --workers 2 --threads 2 --timeout 120"
HTTP port: 8080
Health check path: /readyz</code></pre>

        <h2>Managed PostgreSQL Setup</h2>
        <ol>
          <li>Create a DO Managed PostgreSQL cluster.</li>
          <li>Add your app as a trusted source.</li>
          <li>Set <code>MAKERSPACE_DATABASE_URL</code> in app environment variables.</li>
          <li>Redeploy.</li>
        </ol>
        <pre><code>postgresql://doadmin:REPLACE_PASSWORD@REPLACE_HOST:25060/defaultdb?sslmode=require</code></pre>

        <h2>Troubleshooting (Field-tested)</h2>

        <h3>Run Command Not Executable</h3>
        <ul>
          <li>Clear broken custom run command overrides in DO UI.</li>
          <li>Use the exact run command above.</li>
        </ul>

        <h3>Health Check Failures</h3>
        <ul>
          <li>Confirm bind target is <code>0.0.0.0:$PORT</code>.</li>
          <li>Confirm health route is <code>/readyz</code> or <code>/healthz</code>.</li>
          <li>Increase initial delay to 30-60 seconds for cold starts.</li>
        </ul>

        <h3>Missing Tables (e.g., <code>spaces</code>)</h3>
        <ul>
          <li>Ensure startup runs <code>python3 scripts/bootstrap_db.py</code> before gunicorn.</li>
        </ul>

        <h3>Login Loop / Session Issues</h3>
        <ul>
          <li>Set stable <code>MAKERSPACE_SECRET_KEY</code>.</li>
          <li>Set <code>MAKERSPACE_COOKIE_SECURE=1</code> for HTTPS production.</li>
          <li>Verify database writes are succeeding for sessions.</li>
        </ul>

        <h3>CSRF Token Mismatch</h3>
        <ul>
          <li>Log out and clear cookies.</li>
          <li>Use one canonical HTTPS domain (avoid mixed hostnames).</li>
        </ul>

        <h2>Validation Commands</h2>
        <pre><code>curl -i http://127.0.0.1:8080/healthz
curl -i http://127.0.0.1:8080/readyz</code></pre>
      </article>
    </main>
  </body>
</html>
